<!DOCTYPE html>
<html lang="en">
<head>
  <title>Rooms and Devices</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="animate.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <style>

  /* W3.CSS 4.04 Apr 2017 by Jan Egil and Borge Refsnes */
html{box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}
/* Extract from normalize.css by Nicolas Gallagher and Jonathan Neal git.io/normalize */
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}
img{border-style:none}

::-webkit-input-placeholder{color:inherit;opacity:0.54}
::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}
/* End extract */

html,body{font-family:Verdana,sans-serif;font-size:15px;line-height:1.5}html{overflow-x:hidden}

h3{font-family:"Segoe UI",Arial,sans-serif;font-weight:10;margin:10px 0;color:#3b7aaf;
    text-align:left;
    font-size:3vw;
    display: block;}

html{
    height: 100%;
}

body{
    background-color:white;
    height:100%;
    width:100%;
}


 .logo{
 background-image:url("smart_house_logo.png");
 background-size: 56px 56px;
 background-repeat: no-repeat;
 width: 56px;
 height: 56px;
}

 .justify-center-56px{
  justify-content: center;
  display: flex;
  flex-direction: row;
  height: 56px;
 }

 .flex-center{
  display: flex;
  align-items: center;
 }

 .tam{
    font-size:16px;
 }

 .color{
  background-color: black;
 }

.my-container{
    width:100%;
    height:90%;
}

.left-container{
    background-color:white;
    width: 25%;
    height:95%;
    position:relative;
    right:-2%;
    border-radius: 25px;
    border-width:thin;
    border-color:transparent;
    border-style:solid;
    float:left;
}

.wrapper-room-title{
    background-color: transparent;
    width:100%;
    height:10%;
    padding:-2%;
}

.title-left-container{
    font-family:"Segoe UI",Arial,sans-serif;
    font-weight:10;
    color:#3b7aaf;
    text-align:center;
    font-size:3vw;
    display: block;
}

.left-fine-line{
    width:80%;
    border-right-color: transparent;
    border-left-color: transparent;
    border-top-color:transparent;
    border-bottom-color:#d3d3d3;
    border-style:solid;
    border-bottom-width:thin;
    position:relative;
    top:-20px;
}

.middle{
    background-color:transparent;
    position:relative;
    top:1.5%;
    width:100%;
    height:70%;
}

.wrapper{
    background-color:#D8E4EF;
    position:relative;
    right:-7.5%;
    border-radius: 15px;
    border-color:transparent;
    border-style: solid;
    height: 100%;
    width:85%;
}

.scrollContent{
  overflow-y: auto;
  float: left;
}

.vertical-menu {
    position:relative;
    top:2%;
    right:-8%;
    width: 83%;
    height:95%;
    overflow-y: auto;
    float:left;
    text-overflow: ellipsis;
}

.mod-room{
    width:15%;
    height:100%;
    background-color: white;
    border-right-color: transparent;
    border-bottom-color: transparent;
    border-top-color: transparent;
    border-left-color:#d3d3d3;
    border-left-width: thin;
    border-bottom-right-radius:10px;
    border-top-right-radius:10px;
    color:#3b7aaf;
}

.mod-room:hover{
    background-color: #B1CADF;
    color: black;
}

.mod-room-pencil{
    border-bottom-right-radius:0px;
    border-top-right-radius:0px;
}

.span-a{
    width:100%;
    height:10%;
    display: flex;
    margin-bottom:5%;

    line-height: 20px;
}
.vertical-menu a {
    color: #3b7aaf;
    background-color: white;
    border-bottom-left-radius: 10px;
    border-top-left-radius: 10px;
    display: block;
    width: 83%;
    padding: 5%;
    text-decoration: none;
    font-size:1.5vw;
    display: block;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;

    vertical-align: middle;
}

.vertical-menu a:hover {
    background-color: #B1CADF;
    color:black;
}

.wrapper-button-new-room{
    height:20%;
    width:100%;
    background-color:transparent;
    
}

.button-new-room{
    width:78%;
    height:33%;
    min-width:50%;
    border-radius: 10px;/*
    border-color:#d3d3d3;
    background-color:white;*/
    color:#3b7aaf;
    font-size: 1.5vw;
    position:relative;
    left:11%;
    top:30%;
}

.button-new-room:hover{
    background-color:#B1CADF;
}

.right-container{
    background-color:white;
    width:70%;
    height:95%;
    position:relative;
    right:-4.5%;
    float:left;
    /*border-radius: 25px;*/
    border-style:solid;
    border-width:thin;
    border-left-color: #d3d3d3;
    border-right-color: transparent;
    border-top-color: transparent;
    border-bottom-color:transparent;

}

.wrapper-room-title-two{
    background-color: transparent;
    width:95%;
    height:10%;
    position:relative;
    right:-25px;
    border-radius: 25px;
    margin-bottom:2%;
}

.title-right-container{
    color:#3b7aaf;
    text-align:center;
    font-size:3vw;
    font-family:"Segoe UI",Arial,sans-serif;
    font-weight:10;
    display: block;
}

.right-fine-line{
    width:80%;
    border-right-color: transparent;
    border-left-color: transparent;
    border-top-color:transparent;
    border-bottom-color:#d3d3d3;
    border-style:solid;
    border-bottom-width:thin;
    position:relative;
    top:-20px;
}

.wrapper-devices-container{
    position:relative;
    top:-1.75%;
    left:5%;
    width:90%;
    height:81.25%;
    background-color:#D8E4EF;
    border-radius: 15px;
    border-color:transparent;
    border-style:solid;
}

.devices-container{
    position:relative;
    top:1%;
    width:97%;
    height:97%;
    background-color: #D8E4EF;
    border-radius: 15px;
    overflow-y: auto;

}

.text-starter-devices-container{
    font-size:150%;
    position: relative;
    float: left;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.device-container{
    width:25%;
    height:35%;
    position:relative;
    top:-5%;
    float: left;
    margin-left:5%;
    margin-bottom: 5%;
    
}

.create-device{
    position:relative;
    top:25%;
    width:100%;
    height:100%;
    background-image:url("https://i.imgur.com/3OBKX7l.png");
    background-size: 100% 100%;
    background-repeat: no-repeat;
    border-color:transparent;
    
}

.new-device-button{
	  position:relative;
    top:25%;
    width:100%;
    height:100%;
    background-image:url("https://i.imgur.com/RkNu2T3.jpg");
    background-size: 100% 100%;
    background-repeat: no-repeat;
    border-color:transparent;
}

.hidden-devices{
    display:none;
}

.modal-footer{
  background-color: #D8E4EF;
  border-bottom-right-radius: 12px;
  border-bottom-left-radius: 12px;
 }

.modal-header{
  border-bottom-right-radius: 12px;
  border-bottom-left-radius: 12px;
 }

.modal-text-device{
  font-size:200%;
}


 </style>
</head>
<body onload="loadAll()">

<nav class="navbar navbar-inverse color">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>                        
      </button>
      <a class="navbar-brand logo" href="Home.html"></a>
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav justify-center-56px">
        <li><a class="flex-center tam" href="MyDevices.html">Rooms and Devices</a></li>
        <li><a class="flex-center tam" href="MyCombos.html">Combinations</a></li>
        <li><a class="flex-center tam" href="MyAgenda.html">Agenda</a></li>
        <li><a class="flex-center tam" href="Now On.html">Switched On</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
          <a class="dropdown-toggle flex-center tam" data-toggle="dropdown" href="#">My Profile <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="#">Configurations</a></li>
            <li><a href="#">News</a></li>
            <li><a href="Profiles.html">Change Profile</a></li>
            <li><a href="Main Page.html">Log out</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="my-container" id="main-container">
    <div class="left-container">
        <div class="wrapper-room-title">
            <h1 class="title-left-container">Rooms</h1>
            <hr class="left-fine-line">
        </div>
        <div class="middle">
            <div class="wrapper scrollContent">
                <div class="vertical-menu" id="ver-menu">
                </div>
            </div>
        </div>
        <div class="wrapper-button-new-room">
            <button class="button-new-room btn btn-default" id="new-room">Add room</button>
        </div>
    </div>
    <div class="right-container" id="starter-right-container">
        <div class="wrapper-room-title-two">
            <h1 class="title-right-container">"Room name"</h1>
            <hr class="right-fine-line">
        </div>
        <div class="wrapper-devices-container scrollContent">
            <div class="devices-container">
                <p class="text-starter-devices-container">To see the devices, please select or create a room!!</p>
            </div>
        </div>
    </div>
</div>



<!-- Idea del href del "a" del ver-menu-->
<div class="hidden-devices" id ="hidden-div">
</div>

  
  
<!-- Modal -->
  <div class="modal fade" id="room" role="dialog">
    <div class="modal-dialog">
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title text-center">Add room</h3>
        </div>
        <div class="modal-body">
           <form role="form">
            <div class="form-group">
              <label for="usrname"><span class="glyphicon glyphicon-home"></span> Room name:</label>
              <input type="text" class="form-control" id="room-name" placeholder="Enter room name" name="room-name">
            </div>
           </form>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" onclick="createRoom();" id="new-room-accept">Accept </button>
          <button type="submit" class="btn btn-default" onclick="cancelRoom();">Cancel</button>
        </div>
      </div>  
    </div>
  </div> 
  
  
<!-- Modal -->
  <div class="modal fade" id="device" role="dialog">
    <div class="modal-dialog">
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title text-center">Add device</h3>
        </div>
        <div class="modal-body">
           <form role="form">
            <div class="form-group">
              <label for="usrname">Device name:</label>
              <input type="text" class="form-control" id="device-name" placeholder="Enter device name" name="usrname">
              <label for="descr">Description (optional):</label>
              <input type="text" class="form-control" id="device-description" placeholder="Enter description" name="descr">
            </div>
           </form>
           <p> Select device type
           <select id="comboBoxTypeDevices">
            <option value="none"></option>
           </select>
         </p>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" onclick="createDevice();">Accept </button>
          <button type="submit" class="btn btn-default" data-dismiss="modal">Cancel</button>
        </div>
      </div>  
    </div>
  </div> 
  
  
<!-- Modal de modify-->
  <div class="modal fade" id="modify-room" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title text-center" type="none" id="modify-room-header">Edit room</h3>
        </div>
        <div class="modal-body">
           <form role="form">
            <div class="form-group">
              <p class="room-name-modal" id="actual-room-name"></p>
              <label for="usrname"><span class="glyphicon glyphicon-home"></span> Change room name:</label>
              <input type="text" class="form-control" id="new-room-name" placeholder="Enter new room name" name="new-room-name">
            </div>
           </form>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" onclick="changeName();">Accept </button>
          <button type="submit" class="btn btn-default" id="cancel-modify-room">Cancel</button>
        </div>
      </div>  
    </div>
  </div> 
  
  <!-- Confirmation modal delete-->
  <div class="modal fade" id="confirmation-Delete" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title text-center">Delete room<h3>
        </div>
        <div class="modal-body">
          <p class="confirm-delete-text">Are you sure you want to delete the room? All devices in this room will be deleted.</p>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" onclick="removeRoom()">Accept </button>
          <button type="submit" class="btn btn-default" data-dismiss="modal">Cancel</button>
        </div>  
      </div>
    </div>
  </div> 


<!-- MODALS DE DEVICES-->

<!-- MODAL DE BIND-->
  <div class="modal fade" id="device-blinds" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title text-center">Device Configuration</h3>
        </div>
        <div class="modal-body">
          <p id="blinds-device-name">Device name:</p>
          <p>Device type: Blinds</p>
          <div class ="div-flex">
            <p class="modal-text-device">Device status:</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" >Accept </button>
          <button type="submit" class="btn btn-default" data-dismiss="modal">Cancel</button>
        </div>
      </div>  
    </div>
  
  
<script>

var actualRoomName;

$(document).ready(function(){
    $("#new-room").click(function(){
        document.getElementById("room-name").value = "";
        $("#room").modal();
    });
});

$(document).ready(function(){
    $("#close-create-room").click(function(){
        $("#room").modal("hide");
        document.getElementById("room-name").value = "";
    });
});

$(document).ready(function(){
    $("#cancel-modify-room").click(function(){
        $("#modify-room").modal("hide");
        document.getElementById("new-room-name").value = "";
    });
});

$(document).ready(function(){
    $("#cancel-icon-modify-room").click(function(){
        $("#modify-room").modal("hide");
        document.getElementById("new-room-name").value = "";
    });
});


/* Esto es para que el enter no haga nada */
addEventListener("keydown", function(event) {
    if (event.keyCode == 13){
    }
 });



function cancelRoom(){
    document.getElementById("room-name").value = "";
    $("#room").modal("hide");
}


var api = class {
  static get baseUrl() {
    return "http://127.0.0.1:8080/api/";
  }

  static get timeout() {
    return 60 * 1000;
  }
}
api.room = class {
  static get url() {
    return api.baseUrl + "rooms/";
  }

  static add(room) {
   return $.ajax({
      url: api.room.url,
      method: "POST",
      dataType: "json",
      timeout: api.timeout,
      data: room
    }); 
  }

  static modify(room) {
   return $.ajax({
      url: api.room.url + room.id,
      method: "PUT",
      dataType: "json",
      timeout: api.timeout,
      data: room
    }); 
  }

  static delete(id) {
   return $.ajax({
      url: api.room.url + id,
      method: "DELETE",
      dataType: "json",
      timeout: api.timeout,
    }); 
  }

  static get(id) {
    return $.ajax({
      url: api.room.url + id,
      method: "GET",
      dataType: "json",
      timeout: api.timeout
    });
  }

  static getRoomDevices(id) {
    return $.ajax({
      url: api.room.url + id + "/devices",
      method: "GET",
      dataType: "json",
      timeout: api.timeout
    });
  }


  static getAll(){
  	return $.ajax({
  	  url: "http://127.0.0.1:8080/api/rooms",
      method: "GET",
      dataType: "json",
      timeout: api.timeout
    });
  }
}

api.device = class {
  static get url() {
    return api.baseUrl + "devices/";
  }

  static add(device) {
   return $.ajax({
      url: api.device.url,
      method: "POST",
      dataType: "json",
      timeout: api.timeout,
      data: device
    }); 
  }

  static modify(device) {
   return $.ajax({
      url: api.device.url + device.id,
      method: "PUT",
      dataType: "json",
      timeout: api.timeout,
      data:device
    }); 
  }

  static delete(id) {
   return $.ajax({
      url: api.device.url + id,
      method: "DELETE",
      dataType: "json",
      timeout: api.timeout,
    }); 
  }

  static get(id) {
    return $.ajax({
      url: api.device.url + id,
      method: "GET",
      dataType: "json",
      timeout: api.timeout
    });
  }

  static linkToRoom(idDevice,idRoom){
  	  return $.ajax({
      url: "http://127.0.0.1:8080/api" + /devices/+ idDevice + /rooms/ + idRoom,
      method: "POST",
      dataType: "json",
      timeout: api.timeout
    });
  }

  static getAll(){
  	return $.ajax({
  	  url: "http://127.0.0.1:8080/api/devices",
      method: "GET",
      dataType: "json",
      timeout: api.timeout
    });
  }

  static getTypes(){
    return $.ajax({
      url: "http://127.0.0.1:8080/api/devicetypes",
      method: "GET",
      dataType: "json",
      timeout: api.timeout
    });
  }

  static getType(id){
      return $.ajax({
      url: "http://127.0.0.1:8080/api/devicetypes/" + id,
      method: "GET",
      dataType: "json",
      timeout: api.timeout
    });
  }

  static getState(deviceID,action){
    return $.ajax({
      url: "http://127.0.0.1:8080/api/devices/" + deviceID + "/" + getState,
      method: "PUT",
      dataType: "json",
      timeout: api.timeout,
      data: action
    });
  }
}

api.device.bind = class{
  static up(deviceID){
    return $.ajax({
      url: "http://127.0.0.1:8080/api/devices/" + deviceID + "/" + up,
      method: "PUT",
      dataType: "json",
      timeout: api.timeout,
    });
  }

  static up(deviceID){
    return $.ajax({
      url: "http://127.0.0.1:8080/api/devices/" + deviceID + "/" + down,
      method: "PUT",
      dataType: "json",
      timeout: api.timeout,
    });
  }

}

api.model = api.model || {};

api.model.room = class {
  constructor(id, name, meta) {
    if (id) {
      this.id = id;
    } else {
      delete(this.id);
    }
    this.name = name;
    this.meta = meta;
  }
}

api.model.device = class {
  constructor(typeId, name, meta) {
    if (typeId) {
      this.typeId = typeId;
    } else {
      delete(this.typeId);
    }
    this.name = name;
    this.meta = meta;
  }
}

api.model.action = class{
    constructor(name) {
     this.name = name;
  }
}



function getNameRoom(){
    var name = document.getElementById("room-name").value;
    return name;
}


function createRoom(){
if(! isAlphaNumeric(getNameRoom())){
	alert("The room name must contain only letters or numbers")
	return;
}

if( document.getElementById(getNameRoom())){
    alert("Name already exists");
    return;
}

if(getNameRoom() == ""){
    alert("Please put a name for the room");
    return;
}

if(getNameRoom().length < 3){
  alert("The room name must have at least 3 characters");
  return;
}
var div = document.createElement("div");
div.classList.add("span-a");
var para = document.createElement("a");//Creo el tipo de elemento
para.setAttribute("id", getNameRoom() + "room");
var node = document.createTextNode(getNameRoom()); //le digo su contenido
para.setAttribute("type", getNameRoom());
para.setAttribute("onclick", "showDevicesRoom(this);");
para.setAttribute("href","#");
para.appendChild(node);
para.className = "chargeDiv";
var button = document.createElement("button");
button.setAttribute("onclick", "modifyRoom(this);");
button.setAttribute("id", getNameRoom());
button.classList.add("mod-room");
button.classList.add("mod-room-pencil");
var span = document.createElement("span");
span.classList.add("glyphicon");
span.classList.add("glyphicon-pencil");
var button1 = document.createElement("button");
button1.setAttribute("onclick", "confirmDelete(this);");
button1.setAttribute("id", getNameRoom() + "trash");
button1.setAttribute("data-info",getNameRoom());
button1.classList.add("mod-room");
var span1 = document.createElement("span");
span1.classList.add("glyphicon");
span1.classList.add("glyphicon-trash");
button.appendChild(span);
button1.appendChild(span1);
div.appendChild(para);
div.appendChild(button);
div.appendChild(button1);
var element = document.getElementById("ver-menu");
element.appendChild(div);
createRightContainer(getNameRoom());
var room = new api.model.room(null, getNameRoom(), "{ size: 9 metros }");
api.room.add(room)
$("#room").modal("hide");
}


function loadAll(){
  api.room.getAll()
  .done(function (data) {
    // data tiene el valor retornado por la petición Ajax
    loadRooms(data)
    loadDevices(data)
  })
  .fail(function (jqXHR, textStatus) {
    alert ('Request failed:' + textStatus);
  })
  
  api.device.getTypes()
  .done(function (data) {
    updateNewDeviceModal(data)
  })
  .fail(function (jqXHR, textStatus) {
    alert ('Request failed:' + textStatus);
  }) 
    
  
}

function loadRooms(data){
	var allRooms = data;
	for (var i = 0; i < allRooms.rooms.length; i++) {
    	loadRoom(allRooms.rooms[i])
	}
}

function loadRoom(room){
	var roomName = room.name
	var div = document.createElement("div");
	div.classList.add("span-a");
	var para = document.createElement("a");//Creo el tipo de elemento
	para.setAttribute("id", roomName + "room");
	var node = document.createTextNode(roomName); //le digo su contenido
	para.setAttribute("type", roomName);
	para.setAttribute("onclick", "showDevicesRoom(this);");
	para.setAttribute("href","#");
	para.appendChild(node);
	para.className = "chargeDiv";
	var button = document.createElement("button");
	button.setAttribute("onclick", "modifyRoom(this);");
	button.setAttribute("id", roomName);
	button.classList.add("mod-room");
	button.classList.add("mod-room-pencil");
	var span = document.createElement("span");
	span.classList.add("glyphicon");
	span.classList.add("glyphicon-pencil");
	var button1 = document.createElement("button");
	button1.setAttribute("onclick", "confirmDelete(this);");
	button1.setAttribute("id", roomName + "trash");
	button1.setAttribute("data-info",roomName);
	button1.classList.add("mod-room");
	var span1 = document.createElement("span");
	span1.classList.add("glyphicon");
	span1.classList.add("glyphicon-trash");
	button.appendChild(span);
	button1.appendChild(span1);
	div.appendChild(para);
	div.appendChild(button);
	div.appendChild(button1);
	var element = document.getElementById("ver-menu");
	element.appendChild(div);
	createRightContainer(roomName);
}




function isAlphaNumeric(str) {
  var code, i, len;
  for (i = 0, len = str.length; i < len; i++) {
    code = str.charCodeAt(i);
    if (!(code > 47 && code < 58) && // numeric (0-9)
        !(code > 64 && code < 91) && // upper alpha (A-Z)
        !(code > 96 && code < 123) && // lower alpha (a-z)
        !(code == '-')) { 			  // '-'
      return false;
    }
  }
  return true;
};

function createRightContainer(roomName){

  var hiddenDiv = document.getElementById("hidden-div");

    var div = document.createElement("div");
    var idDivName = roomName + "holder";
    div.classList.add("right-container");
    div.setAttribute("id", idDivName);
    var div2 = document.createElement("div");
    div2.classList.add("wrapper-room-title-two");
    var h1 = document.createElement("h1");
    h1.classList.add("title-right-container");
    var h1Id = "title-room-" + roomName;
    h1.setAttribute("id",h1Id);
    var node = document.createTextNode(roomName);
    h1.appendChild(node);
    var hr = document.createElement("hr");
    hr.classList.add("right-fine-line");
    
    var div3 = document.createElement("div");
    div3.classList.add("wrapper-devices-container");
    var div4 = document.createElement("div");
    div4.classList.add("devices-container");
    div4.setAttribute("id", roomName + "devices-container");
    var div5 = document.createElement("div");
    div5.classList.add("device-container");
    var button = document.createElement("button");
    button.classList.add("create-device");
    button.setAttribute("onclick","openCreateDeviceModal();");
    var idButtonName = roomName + "new-device";
    button.setAttribute("id", idButtonName);
    
    
    hiddenDiv.appendChild(div);
    div.appendChild(div2);
    div.appendChild(div3);
    
    div2.appendChild(h1);
    div2.appendChild(hr);
    
    div3.appendChild(div4);
    div4.appendChild(div5);
    
    div5.appendChild(button);

}

function showDevicesRoom(nameRoom){
  var hiddenDiv = document.getElementById("hidden-div")
  var mainDiv = document.getElementById("main-container");
  requiredDiv = mainDiv.children[1];
  clone = requiredDiv.cloneNode(true);//problema espacio
  hiddenDiv.appendChild(clone);
  var idName = "#" + nameRoom.getAttribute("type") + "holder";
  var idName2 = nameRoom.getAttribute("type") + "holder";
  var idRightDevicesContainer = document.getElementById(nameRoom.getAttribute("type") + "devices-container")
  var modalDevice = document.getElementById("device");
  actualRoomName = nameRoom.getAttribute("type");
  modalDevice.setAttribute("type", idRightDevicesContainer.getAttribute("id"));
  $(requiredDiv).replaceWith($(idName));
}

function showInitialDevicesRoom(){
  var hiddenDiv = document.getElementById("hidden-div")
  var mainDiv = document.getElementById("main-container");
  requiredDiv = mainDiv.children[1];
  $(requiredDiv).replaceWith( $("#starter-right-container"));
}

function modifyRoom(button){
 document.getElementById("modify-room-header").setAttribute("type",button.getAttribute('id'));
 var roomName = button.getAttribute('id');
 document.getElementById("actual-room-name").innerHTML = "Actual room name: " + roomName;
 $("#modify-room").modal();
}

function getNewNameRoom(){
    var newName = document.getElementById("new-room-name").value;
    return newName;
}

function changeName(){
	if(! isAlphaNumeric(getNewNameRoom())){
		alert("The room name must contain only letters or numbers")
		return;
	}

    if( document.getElementById(getNewNameRoom())){
    alert("Name already exists");
    return;
}

    if(getNewNameRoom() == ""){
        alert("Please put a name to change the room name");
        return;
}

if(getNewNameRoom().length < 3){
  alert("The room name must have at least 3 characters");
  return;
}

	var info = document.getElementById("modify-room-header");
	var oldName = info.getAttribute("type")
    var trashButton = document.getElementById(info.getAttribute("type") + "trash");
    var rightContainer = document.getElementById(info.getAttribute("type") + "holder")
    var idroom = info.getAttribute("type") + "room";
    var idbutton = info.getAttribute("type");
    var editButton = document.getElementById(idbutton);
    var titleId = "title-room-" + info.getAttribute("type");
    var title = document.getElementById(titleId);
    var newTitle = getNewNameRoom();
    var newDeviceButton = document.getElementById(info.getAttribute("type") + "new-device");
    title.innerHTML = newTitle;
    var room = document.getElementById(idroom);
    var devCont = document.getElementById(info.getAttribute("type") + "devices-container");
    devCont.setAttribute("id", getNewNameRoom() + "devices-container");
    newDeviceButton.setAttribute("id", getNewNameRoom() + "new-device")
    room.setAttribute("id",getNewNameRoom() + "room");
    room.setAttribute("type", getNewNameRoom());
    title.setAttribute("id", "title-room-" + newTitle);
    editButton.setAttribute("id",getNewNameRoom());
    trashButton.setAttribute("data-info",getNewNameRoom());
    trashButton.setAttribute("id", getNewNameRoom() + "trash")
    rightContainer.setAttribute("id" , getNewNameRoom() + "holder")
    room.innerHTML = getNewNameRoom();
    if(actualRoomName == info.getAttribute("type")){
    	actualRoomName = getNewNameRoom();
    	var modalDevice = document.getElementById("device");
    	modalDevice.setAttribute("type", devCont.getAttribute("id"));

    }
    var newName = getNewNameRoom()
    document.getElementById("new-room-name").value = "";
    info.setAttribute("type", getNewNameRoom());
    modifyRoomFromDB(oldName,newName)
    $("#modify-room").modal("hide");

}

function modifyRoomFromDB(roomName, newRoomName){
	api.room.getAll()
  .done(function (data) {
    findAndUpdate(data,roomName,newRoomName)
  })
  .fail(function (jqXHR, textStatus) {
    alert ('Request failed:' + textStatus);
  })
}

function findAndUpdate(data,roomName,newRoomName){
	var allRooms = data;
	var idRoom;
	for (var i = 0; i < allRooms.rooms.length; i++) {
    	if(roomName == allRooms.rooms[i].name){
    		idRoom = allRooms.rooms[i].id;
    	}
	}
	var modifiedRoom = new api.model.room(idRoom, newRoomName, "{ size: \"9m2\" }");
	api.room.modify(modifiedRoom)
}

function confirmDelete(roomName){
    $("#modify-room").modal("hide");
    updateRoomToDelete(roomName);
    $("#confirmation-Delete").modal();
}

function updateRoomToDelete(roomName){
  var updateName = roomName.getAttribute("data-info");
  document.getElementById("modify-room-header").setAttribute("type",updateName);

}

function closeConfirmationRoomDelete(){
    $("#confirmation-Delete").modal("hide");
    $("#modify-room").modal();
}

function removeRoom(){  
    var info = document.getElementById("modify-room-header");
    var rightContainer = document.getElementById(info.getAttribute("type") + "holder")
    var idroom = info.getAttribute("type") + "room";
    var room = document.getElementById(idroom);
    var parentRoom = room.parentNode
    parentRoom.parentNode.removeChild(parentRoom);
    if(actualRoomName == info.getAttribute("type")){
    	showInitialDevicesRoom();
   	}
   	document.getElementById("hidden-div").appendChild(rightContainer);
   	rightContainer.parentNode.removeChild(rightContainer);
    $("#confirmation-Delete").modal("hide");
    removeRoomFromDB(info.getAttribute("type"))
}

function removeRoomFromDB(roomName){
	api.room.getAll()
  .done(function (data) {
    findAndDelete(data,roomName)
  })
  .fail(function (jqXHR, textStatus) {
    alert ('Request failed:' + textStatus);
  })
}

function findAndDelete(data,roomName){
	var allRooms = data;
	var idRoom;
	for (var i = 0; i < allRooms.rooms.length; i++) {
    	if(roomName == allRooms.rooms[i].name){
    		idRoom = allRooms.rooms[i].id;
    		deleteAllDevicesOfRoom(allRooms.rooms[i])
    	}
	}
	api.room.delete(idRoom)
}

function deleteAllDevicesOfRoom(room){
	api.room.getRoomDevices(room.id)
  .done(function (data) {
    deleteAllDevices(data,room)
  })
  .fail(function (jqXHR, textStatus) {
    alert ('Request failed:' + textStatus);
  })
}

function deleteAllDevices(data,room){
	var allDevices = data;
	for (var i = 0; i < allDevices.devices.length; i++){
		api.device.delete(allDevices.devices[i].id)
	}
}

function openCreateDeviceModal(){
	$("#device").modal()  
}

function createDevice(){
  var comboBoxTypeDevices = document.getElementById("comboBoxTypeDevices")
  var deviceTypeId = comboBoxTypeDevices.options[comboBoxTypeDevices.selectedIndex].value
  var deviceName = document.getElementById("device-name").value;
  if(deviceTypeId == "none"){
    alert("You have not selected a device type");
    return;
  }
  
  if(deviceName.length < 3){
    alert("The room name must have at least 3 characters");
    return;
  }

	var info = document.getElementById("device");
	var idDevicesContainer = info.getAttribute("type") //esto me da el id del devices-container
	var devicesContainer = document.getElementById(idDevicesContainer);
	var deviceContainer = document.createElement("div");
	var deviceDesc =document.getElementById("device-description").value;
	var description = "{ Description: " + deviceDesc + " }";
	deviceContainer.classList.add("device-container");
	deviceContainer.setAttribute("data-name",deviceName)
	deviceContainer.setAttribute("data-desc",deviceDesc)
  deviceContainer.setAttribute("data-typeID",deviceTypeId)
  deviceContainer.setAttribute("data-ID",device.id)
	var buttonDevice = document.createElement("button");
  buttonDevice.classList.add("new-device-button");
	setDeviceImage(buttonDevice, deviceTypeId)
  buttonDevice.setAttribute("onclick","viewState(this)");
  buttonDevice.classList.add("new-device-button");
  buttonDevice.setAttribute("data-name",device.name)
  buttonDevice.setAttribute("data-desc",device.meta)
  buttonDevice.setAttribute("data-typeID",device.typeId)
  buttonDevice.setAttribute("data-ID",device.id)
	deviceContainer.appendChild(buttonDevice);
	devicesContainer.appendChild(deviceContainer);
	var newDeviceButton = document.getElementById(actualRoomName + "new-device");
	var parentNewDeviceButton = newDeviceButton.parentNode
	parentNewDeviceButton.parentNode.removeChild(parentNewDeviceButton);
	devicesContainer.appendChild(parentNewDeviceButton);
	var newDevice = new api.model.device(deviceTypeId, deviceName, description);
	api.device.add(newDevice);
	addDeviceToRoom(actualRoomName,deviceName);
	document.getElementById("device-name").value = "";
	document.getElementById("device-description").value = "";
  comboBoxTypeDevices.selectedIndex = "0";
	$("#device").modal("hide") 
}

function setDeviceImage(buttonDevice,deviceTypeId){
  api.device.getType(deviceTypeId)
  .done(function (data) {
    switch(data.device.name) {
    case "blinds":
        buttonDevice.style.backgroundImage = "url('Blinds.png')";
        buttonDevice.setAttribute("data-type","blinds")
        break;
    case "lamp":
        buttonDevice.style.backgroundImage = "url('Lamp.png')";
        buttonDevice.setAttribute("data-type","lamp")
        break;
    case "oven":
        buttonDevice.style.backgroundImage = "url('Oven.png')";
        buttonDevice.setAttribute("data-type","oven")
        break;
    case "ac":
        buttonDevice.style.backgroundImage = "url('Ac.png')";
        buttonDevice.setAttribute("data-type","ac")
        break;
    case "alarm":
        buttonDevice.style.backgroundImage = "url('Alarm.png')";
        buttonDevice.setAttribute("data-type","alarm")
        break;
    case "timer":
        buttonDevice.style.backgroundImage = "url('Timer.png')";
        buttonDevice.setAttribute("data-type","timer")
        break;
    case "door":
        buttonDevice.style.backgroundImage = "url('Door.png')";
        buttonDevice.setAttribute("data-type","door")
        break;
    case "refrigerator":
        buttonDevice.style.backgroundImage = "url('Fridge.png')";
        buttonDevice.setAttribute("data-type","refrigerator")
        break;
    default:
        buttonDevice.style.backgroundImage = "url('Default.png')";
}
  })
  .fail(function (jqXHR, textStatus) {
    alert ('Request failed:' + textStatus);
  })
}

function addDeviceToRoom(roomName,deviceName){
  api.room.getAll()
  .done(function (data) {
    findRoomForDevice(data,roomName,deviceName)
  })
  .fail(function (jqXHR, textStatus) {
    alert ('Request failed:' + textStatus);
  })
}

function findRoomForDevice(dato,roomName,deviceName){
	var allRooms = dato;
	var idRoom;
	for (var i = 0; i < allRooms.rooms.length; i++) {
    	if(roomName == allRooms.rooms[i].name){
    		idRoom = allRooms.rooms[i].id;
    	}
	}
  api.device.getAll()
  .done(function (data) {
    findDeviceForRoom(data,idRoom,deviceName)
  })
  .fail(function (jqXHR, textStatus) {
    alert ('Request failed:' + textStatus);
  })
}

function findDeviceForRoom(data,idRoom,deviceName){
	var allDevices = data;
	var idDevice;
	for (var i = 0; i < allDevices.devices.length; i++) {
    	if(deviceName == allDevices.devices[i].name){
    		idDevice = allDevices.devices[i].id;
    	}
	}
	api.device.linkToRoom(idDevice,idRoom);
}

function loadDevices(data){
	var allRooms = data;
	for (var i = 0; i < allRooms.rooms.length; i++) {
		getDevices(allRooms.rooms[i])
	}
}

function getDevices(room){
	api.room.getRoomDevices(room.id)
	.done(function (data) {
    	chargeDevices(data,room)
  })
	.fail(function (jqXHR, textStatus) {
    	alert ('Request failed:' + textStatus);
  })
}

function chargeDevices(data,room){
	var allDevices = data;
	for (var i = 0; i < allDevices.devices.length; i++){
		chargeDevice(allDevices.devices[i],room)
	}
	
}

function chargeDevice(device,room){
	var idDevicesContainer = room.name + "devices-container"
	var devicesContainer = document.getElementById(idDevicesContainer);
	var deviceContainer = document.createElement("div");
	deviceContainer.classList.add("device-container");
	deviceContainer.setAttribute("data-name",device.name)
	deviceContainer.setAttribute("data-desc",device.meta)
  deviceContainer.setAttribute("data-typeID",device.typeId)
  deviceContainer.setAttribute("data-ID",device.id)
	var buttonDevice = document.createElement("button");
  setDeviceImage(buttonDevice, device.typeId)
  buttonDevice.setAttribute("onclick","viewState(this)");
	buttonDevice.classList.add("new-device-button");
  buttonDevice.setAttribute("data-name",device.name)
  buttonDevice.setAttribute("data-desc",device.meta)
  buttonDevice.setAttribute("data-typeID",device.typeId)
  buttonDevice.setAttribute("data-ID",device.id)
	deviceContainer.appendChild(buttonDevice);
	devicesContainer.appendChild(deviceContainer);
	var newDeviceButton = document.getElementById(room.name + "new-device");
	var parentNewDeviceButton = newDeviceButton.parentNode
	parentNewDeviceButton.parentNode.removeChild(parentNewDeviceButton);
	devicesContainer.appendChild(parentNewDeviceButton);
}

function updateNewDeviceModal(data){
  var allDevicesTypes = data;
  var typeName;
  for (var i = 0; i < allDevicesTypes.devices.length; i++){
    typeName = allDevicesTypes.devices[i].name
    var select = document.getElementById("comboBoxTypeDevices")
    var option = document.createElement("option")
    option.setAttribute("value",allDevicesTypes.devices[i].id)
    option.innerHTML = typeName
    select.appendChild(option)
  }
}

function viewState(button){
   var modalId = "#device-" + button.getAttribute("data-type")
   updateDeviceModal(button)
   $(modalId).modal();
}

function updateDeviceModal(button){
  document.getElementById("blinds-device-name").innerHTML = "Device name: " +  button.getAttribute("data-name")
}
</script>
</body>
</html>
